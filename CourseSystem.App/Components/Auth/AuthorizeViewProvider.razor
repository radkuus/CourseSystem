@using CourseSystem.App.Services
@using CourseSystem.App.Models
@implements IDisposable
@inject AuthenticationService AuthService
@inject NavigationManager Navigation

<CascadingValue Value="@_authState">
    @ChildContent
</CascadingValue>

@code {
    [Parameter] public RenderFragment? ChildContent { get; set; }

    private AuthState _authState = new();
    private Timer? _timer;

    protected override void OnInitialized()
    {
        // Subskrybuj zmiany lokalizacji
        Navigation.LocationChanged += OnLocationChanged;

        CheckAuth();

        // Sprawdzaj autoryzację co 5 sekund (częściej niż 30)
        _timer = new Timer(_ =>
        {
            InvokeAsync(() =>
            {
                CheckAuth();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        // Sprawdź autoryzację przy każdej zmianie strony
        CheckAuth();
        InvokeAsync(StateHasChanged);
    }

    private void CheckAuth()
    {
        try
        {
            var result = AuthService.CheckAuth();

            // Jeśli stan się zmienił, wymuś odświeżenie
            if (_authState.IsAuthenticated != result.IsAuthenticated)
            {
                _authState.IsAuthenticated = result.IsAuthenticated;
                _authState.User = result.User;
            }
            else
            {
                _authState.IsAuthenticated = result.IsAuthenticated;
                _authState.User = result.User;
            }
        }
        catch
        {
            _authState.IsAuthenticated = false;
            _authState.User = null;
        }
    }

    public void RefreshAuthState()
    {
        CheckAuth();
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
        _timer?.Dispose();
    }

    public class AuthState
    {
        public bool IsAuthenticated { get; set; }
        public UserInfo? User { get; set; }
    }
}